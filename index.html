<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>PIPC Campo</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=IBM+Plex+Sans:wght@300;400;600&display=swap" rel="stylesheet">
<style>
:root{--bg:#0f1117;--surface:#1a1d27;--surface2:#222535;--border:#2e3245;--accent:#f0b429;--accent2:#4ade80;--danger:#f87171;--text:#e8eaf0;--text2:#8b90a7;--field-bg:#131620;--radius:8px;--mono:'IBM Plex Mono',monospace;--sans:'IBM Plex Sans',sans-serif;}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:var(--sans);background:var(--bg);color:var(--text);min-height:100vh;font-size:14px;}
.header{background:var(--surface);border-bottom:2px solid var(--accent);padding:12px 16px;position:sticky;top:0;z-index:100;display:flex;align-items:center;gap:12px;}
.header-logo{font-family:var(--mono);font-size:11px;font-weight:600;color:var(--accent);letter-spacing:2px;line-height:1.2;}
.header-site{flex:1;font-size:12px;color:var(--text2);font-family:var(--mono);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.header-site span{color:var(--text);font-weight:600;}
.btn-hdr{background:var(--accent);color:#000;border:none;padding:7px 14px;border-radius:var(--radius);font-family:var(--mono);font-size:11px;font-weight:600;cursor:pointer;letter-spacing:1px;white-space:nowrap;}
.btn-hdr:disabled{opacity:.4;cursor:not-allowed;}
.screen{display:none;}.screen.active{display:block;}
.wrap{padding:28px 20px;max-width:520px;margin:0 auto;}
.pg-title{font-family:var(--mono);font-size:22px;font-weight:600;color:var(--accent);margin-bottom:4px;}
.pg-sub{font-size:13px;color:var(--text2);margin-bottom:24px;line-height:1.6;}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:16px;}
.lbl{font-family:var(--mono);font-size:10px;letter-spacing:1.5px;color:var(--text2);text-transform:uppercase;display:block;margin-bottom:6px;}
.inp{width:100%;background:var(--field-bg);border:1px solid var(--border);border-radius:6px;padding:10px 12px;color:var(--text);font-family:var(--mono);font-size:13px;outline:none;margin-bottom:12px;}
.inp:focus{border-color:var(--accent);}
.err-txt{color:var(--danger);font-family:var(--mono);font-size:11px;min-height:14px;margin-bottom:10px;}
.hint-txt{font-size:11px;color:var(--text2);margin-bottom:14px;line-height:1.5;}
.srch-inp{width:100%;background:var(--surface);border:2px solid var(--border);border-radius:var(--radius);padding:12px 16px;color:var(--text);font-family:var(--sans);font-size:15px;outline:none;margin-bottom:12px;}
.srch-inp:focus{border-color:var(--accent);}
.res-list{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;}
.res-item{padding:14px 16px;border-bottom:1px solid var(--border);cursor:pointer;}
.res-item:last-child{border-bottom:none;}
.res-item:active{background:var(--surface2);}
.res-name{font-weight:600;font-size:14px;}
.res-sub{font-size:11px;color:var(--text2);font-family:var(--mono);margin-top:3px;}
.btn-new{width:100%;background:transparent;border:2px dashed var(--border);border-radius:var(--radius);padding:14px;color:var(--text2);font-family:var(--mono);font-size:12px;cursor:pointer;margin-top:12px;letter-spacing:1px;}
.btn-link{width:100%;background:transparent;border:none;color:var(--text2);font-family:var(--mono);font-size:10px;margin-top:16px;cursor:pointer;letter-spacing:1px;padding:8px;}
.status{font-family:var(--mono);font-size:11px;padding:8px 12px;border-radius:6px;margin-bottom:12px;display:none;}
.status.info{background:#1e2a3a;color:#60a5fa;border:1px solid #1d4ed8;display:block;}
.status.error{background:#2a1515;color:var(--danger);border:1px solid #7f1d1d;display:block;}
.offline-bar{background:#2a1515;border:1px solid var(--danger);border-radius:var(--radius);padding:12px 16px;margin-bottom:14px;display:none;font-family:var(--mono);font-size:11px;color:var(--danger);align-items:center;gap:10px;}
.offline-bar.show{display:flex;}
.sync-bar{background:#14261e;border:1px solid var(--accent2);border-radius:var(--radius);padding:12px 16px;margin-bottom:14px;display:none;font-family:var(--mono);font-size:11px;color:var(--accent2);align-items:center;gap:10px;}
.sync-bar.show{display:flex;}
.sync-bar span{flex:1;}
.btn-sync{background:var(--accent2);color:#000;border:none;padding:7px 14px;border-radius:6px;font-family:var(--mono);font-size:11px;font-weight:600;cursor:pointer;white-space:nowrap;}
.pending-badge{background:var(--danger);color:#fff;font-family:var(--mono);font-size:10px;font-weight:600;padding:2px 7px;border-radius:10px;margin-left:6px;}
.offline-item{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:10px 14px;margin-bottom:8px;display:flex;align-items:center;gap:10px;}
.offline-item-name{flex:1;font-size:13px;font-weight:600;}
.offline-item-meta{font-family:var(--mono);font-size:10px;color:var(--text2);}
.offline-item-err{font-family:var(--mono);font-size:10px;color:var(--danger);margin-top:3px;}
.form-wrap{padding:16px;max-width:600px;margin:0 auto;padding-bottom:90px;}
.tabs{display:flex;gap:4px;margin-bottom:20px;overflow-x:auto;padding-bottom:4px;scrollbar-width:none;}
.tabs::-webkit-scrollbar{display:none;}
.tab{flex-shrink:0;padding:7px 14px;border-radius:20px;font-family:var(--mono);font-size:11px;font-weight:600;cursor:pointer;border:1px solid var(--border);background:transparent;color:var(--text2);}
.tab.active{background:var(--accent);color:#000;border-color:var(--accent);}
.tab.ft.active{background:var(--accent2);border-color:var(--accent2);color:#000;}
.tc{display:none;}.tc.active{display:block;}
.sec{margin-bottom:20px;}
.sec-title{font-family:var(--mono);font-size:10px;font-weight:600;letter-spacing:2px;color:var(--text2);text-transform:uppercase;padding:0 0 8px;border-bottom:1px solid var(--border);margin-bottom:12px;display:flex;align-items:center;gap:8px;}
.bdg{background:var(--accent);color:#000;font-size:8px;padding:2px 6px;border-radius:10px;}
.bdg.f{background:var(--accent2);}
.f{margin-bottom:14px;}
.f label{display:block;font-family:var(--mono);font-size:10px;letter-spacing:1px;color:var(--text2);text-transform:uppercase;margin-bottom:5px;}
.f input,.f textarea,.f select{width:100%;background:var(--field-bg);border:1px solid var(--border);border-radius:6px;padding:9px 12px;color:var(--text);font-family:var(--sans);font-size:14px;outline:none;appearance:none;-webkit-appearance:none;}
.f input:focus,.f textarea:focus,.f select:focus{border-color:var(--accent);}
.f textarea{resize:vertical;min-height:68px;}
.fi input,.fi textarea,.fi select{border-color:#2d4a35;background:#111a14;}
.fi input:focus,.fi textarea:focus{border-color:var(--accent2);}
.fi label{color:var(--accent2);}
.cw{display:flex;align-items:center;background:var(--field-bg);border:1px solid var(--border);border-radius:6px;overflow:hidden;}
.cw.fi{border-color:#2d4a35;background:#111a14;}
.cb{background:var(--surface2);border:none;color:var(--text);font-size:20px;width:44px;height:44px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.cb:active{background:var(--border);}
.ci{flex:1;background:transparent;border:none;color:var(--text);font-family:var(--mono);font-size:16px;font-weight:600;text-align:center;outline:none;width:0;padding:0;}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;}
.bot-bar{position:fixed;bottom:0;left:0;right:0;background:var(--surface);border-top:1px solid var(--border);padding:12px 16px;display:flex;gap:10px;z-index:100;}
.btn-back{background:var(--surface2);border:1px solid var(--border);color:var(--text2);padding:12px 20px;border-radius:var(--radius);font-family:var(--mono);font-size:12px;cursor:pointer;}
.btn-save{flex:1;background:var(--accent);border:none;color:#000;padding:12px;border-radius:var(--radius);font-family:var(--mono);font-size:13px;font-weight:600;cursor:pointer;letter-spacing:1px;}
.btn-save:disabled{opacity:.4;cursor:not-allowed;}
.toast{position:fixed;top:70px;left:50%;transform:translateX(-50%) translateY(-20px);background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:10px 20px;border-radius:20px;font-family:var(--mono);font-size:12px;opacity:0;transition:all .3s;pointer-events:none;white-space:nowrap;z-index:200;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
.toast.ok{border-color:var(--accent2);color:var(--accent2);}
.toast.err{border-color:var(--danger);color:var(--danger);}
.brig{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px;margin-bottom:14px;}
.brig-t{font-family:var(--mono);font-size:10px;color:var(--accent);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:10px;}
small{font-size:10px;color:var(--text2);font-family:var(--mono);margin-top:3px;display:block;}
.firma-wrap{background:#ffffff;border:2px solid var(--border);border-radius:var(--radius);
  overflow:hidden;touch-action:none;cursor:crosshair;display:block;width:100%;}
.firma-wrap.activo{border-color:var(--accent2);}
#firmaCanvas{display:block;width:100%;height:220px;}
.firma-btns{display:flex;gap:10px;margin-top:12px;}
.btn-firma-clear{flex:1;background:var(--surface2);border:1px solid var(--border);color:var(--text2);
  padding:11px;border-radius:var(--radius);font-family:var(--mono);font-size:12px;cursor:pointer;}
.btn-firma-save{flex:2;background:var(--accent2);border:none;color:#000;
  padding:11px;border-radius:var(--radius);font-family:var(--mono);font-size:12px;font-weight:600;cursor:pointer;}
.firma-preview{margin-top:14px;display:none;}
.firma-preview img{width:100%;border:1px solid var(--accent2);border-radius:6px;}
.firma-ok{font-family:var(--mono);font-size:11px;color:var(--accent2);margin-top:6px;text-align:center;}
.foto-menu-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:300;display:none;align-items:flex-end;}
.foto-menu-overlay.show{display:flex;}
.foto-menu{background:var(--surface);border-radius:16px 16px 0 0;padding:20px 16px 32px;width:100%;}
.foto-menu-title{font-family:var(--mono);font-size:11px;color:var(--text2);letter-spacing:1.5px;
  text-align:center;margin-bottom:16px;}
.foto-menu-btn{width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--text);
  padding:14px;border-radius:var(--radius);font-family:var(--sans);font-size:15px;cursor:pointer;
  margin-bottom:10px;display:flex;align-items:center;gap:12px;}
.foto-menu-btn:active{opacity:.7;}
.foto-menu-cancel{width:100%;background:transparent;border:none;color:var(--text2);
  font-family:var(--mono);font-size:12px;padding:12px;cursor:pointer;margin-top:4px;}
.foto-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:4px;}
.foto-slot{background:var(--field-bg);border:1px solid var(--border);border-radius:6px;
  padding:8px;cursor:pointer;transition:border-color .15s;-webkit-tap-highlight-color:transparent;
  display:flex;flex-direction:column;align-items:center;gap:6px;}
.foto-slot:active{opacity:.7;}
.foto-slot.done{border-color:var(--accent2);}
.foto-thumb{width:100%;height:64px;object-fit:cover;border-radius:4px;display:none;}
.foto-icon{font-size:28px;height:64px;display:flex;align-items:center;justify-content:center;width:100%;}
.foto-slot.done .foto-icon{display:none;}
.foto-slot.done .foto-thumb{display:block;}
.foto-name{font-family:var(--mono);font-size:9px;color:var(--text2);text-align:center;
  word-break:break-all;line-height:1.3;}
.foto-slot.done .foto-name{color:var(--accent2);}
.bulk-box{background:var(--field-bg);border:1px solid var(--border);border-radius:6px;
  padding:14px;margin-bottom:8px;}
.bulk-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
.bulk-label{font-family:var(--mono);font-size:11px;color:var(--text2);letter-spacing:1px;}
.bulk-count{font-family:var(--mono);font-size:11px;color:var(--accent2);font-weight:600;}
.btn-bulk{background:var(--surface2);border:1px solid var(--border);color:var(--text);
  padding:8px 14px;border-radius:6px;font-family:var(--mono);font-size:11px;cursor:pointer;width:100%;}
.btn-bulk:active{opacity:.7;}
.bulk-thumbs{display:flex;flex-wrap:wrap;gap:4px;margin-top:8px;}
.bulk-thumb{width:48px;height:48px;object-fit:cover;border-radius:4px;border:1px solid var(--accent2);}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>

<div class="header">
  <div class="header-logo">PIPC<br>CAMPO</div>
  <div class="header-site" id="hSite">‚Äî selecciona un sitio ‚Äî</div>
  <button class="btn-hdr" id="btnHdr" onclick="guardar()" style="display:none">GUARDAR</button>
</div>
<div class="toast" id="toast"></div>

<!-- SETUP -->
<div class="screen" id="sSetup">
  <div class="wrap">
    <div class="pg-title">Configuraci√≥n</div>
    <div class="pg-sub">Ingresa tu token de Airtable. Solo se pide una vez y se guarda en este dispositivo.</div>
    <div class="card">
      <span class="lbl">Personal Access Token de Airtable</span>
      <input class="inp" type="text" id="iApiKey" placeholder="pat...">
      <div class="err-txt" id="setupErr"></div>
      <div class="hint-txt">Encu√©ntralo en Airtable ‚Üí tu perfil ‚Üí Developer Hub ‚Üí Personal access tokens</div>
      <button onclick="saveKey()" style="width:100%;background:var(--accent);border:none;color:#000;padding:12px;border-radius:var(--radius);font-family:var(--mono);font-size:13px;font-weight:600;cursor:pointer;">GUARDAR Y CONTINUAR</button>
    </div>
  </div>
</div>

<!-- B√öSQUEDA -->
<div class="screen" id="sSearch">
  <div class="wrap">
    <div class="pg-title">Levantamiento <span id="pendBadge" class="pending-badge" style="display:none"></span></div>
    <div class="pg-sub">Busca el sitio o crea uno nuevo</div>
    <div class="offline-bar" id="offlineBar">‚ö† Sin conexi√≥n ‚Äî los registros se guardar√°n localmente</div>
    <div class="sync-bar" id="syncBar">
      <span id="syncMsg"></span>
      <button class="btn-sync" onclick="sincronizar()">‚Üë SINCRONIZAR</button>
    </div>
    <div class="status" id="statusMsg"></div>
    <input class="srch-inp" type="text" id="srchInp" placeholder="Buscar por nombre del sitio..." oninput="buscar(this.value)">
    <div class="res-list" id="resList" style="display:none"></div>
    <button class="btn-new" onclick="nuevoReg()">+ NUEVO SITIO</button>
    <button class="btn-link" onclick="changeKey()">‚öô Cambiar API Key</button>
  </div>
</div>

<!-- FORMULARIO -->
<div class="screen" id="sForm">
  <div class="form-wrap">
    <div class="tabs">
      <button class="tab active" onclick="tab('tGen',this)">General</button>
      <button class="tab"        onclick="tab('tUbi',this)">Ubicaci√≥n</button>
      <button class="tab ft"     onclick="tab('tInv',this)">üìã Inventario</button>
      <button class="tab ft"     onclick="tab('tSen',this)">üî∞ Se√±ales</button>
      <button class="tab"        onclick="tab('tRie',this)">Riesgos</button>
      <button class="tab"        onclick="tab('tPob',this)">Poblaci√≥n</button>
      <button class="tab"        onclick="tab('tBri',this)">Brigadas</button>
      <button class="tab"        onclick="tab('tFotos',this)">üì∑ Fotos</button>
      <button class="tab"        onclick="tab('tFirma',this)">‚úçÔ∏è Firma</button>
    </div>

    <!-- GENERAL -->
    <div class="tc active" id="tGen">
      <div class="sec"><div class="sec-title">Identificaci√≥n</div>
        <div class="f"><label>Nombre Comercial</label><input type="text" id="nombre_comercial"></div>
        <div class="g2">
          <div class="f"><label>Categor√≠a</label><input type="text" id="Categoria"></div>
          <div class="f"><label>RFC</label><input type="text" id="rfc"></div>
        </div>
        <div class="f"><label>Raz√≥n Social</label><input type="text" id="razon_social"></div>
        <div class="f"><label>Giro Comercial</label><input type="text" id="giro_comercial"></div>
        <div class="f"><label>Descripci√≥n Actividades</label><textarea id="descripcion_actividades"></textarea></div>
      </div>
      <div class="sec"><div class="sec-title">Contacto</div>
        <div class="f"><label>Tel√©fono</label><input type="tel" id="telefono" placeholder="(000) 000-0000" maxlength="14" oninput="fmtTel(this)"></div>
        <div class="f"><label>Email</label><input type="email" id="email"></div>
      </div>
      <div class="sec"><div class="sec-title">Operaci√≥n</div>
        <div class="f"><label>D√≠as de Trabajo</label><input type="text" id="dias_trabajo"></div>
        <div class="f"><label>Horario</label><input type="text" id="horario"></div>
        <div class="g2">
          <div class="f"><label>Turnos</label><input type="number" id="turnos" min="1"></div>
          <div class="f"><label>Antig√ºedad</label><input type="text" id="antiguedad_inmueble"></div>
        </div>
        <div class="f"><label>Inicio de Operaciones</label>
          <input type="date" id="inicio_operaciones">
          <small>Se guardar√° como: 19 de febrero de 2026</small>
        </div>
      </div>
      <div class="sec"><div class="sec-title">Estructura</div>
        <div class="g2">
          <div class="f"><label>Edificios</label><div class="cw"><button class="cb" onclick="cnt('edificios',-1)">‚àí</button><input class="ci" type="number" id="edificios" value="0" min="0"><button class="cb" onclick="cnt('edificios',1)">+</button></div></div>
          <div class="f"><label>Niveles</label><div class="cw"><button class="cb" onclick="cnt('niveles',-1)">‚àí</button><input class="ci" type="number" id="niveles" value="0" min="0"><button class="cb" onclick="cnt('niveles',1)">+</button></div></div>
        </div>
        <div class="g2">
          <div class="f"><label>Terreno m¬≤</label><input type="number" id="terreno_m2" step="0.01"></div>
          <div class="f"><label>Construcci√≥n m¬≤</label><input type="number" id="construccion_m2" step="0.01"></div>
        </div>
        <div class="f"><label>Estacionamiento</label><input type="text" id="estacionamiento"></div>
      </div>
      <div class="sec"><div class="sec-title">Acta</div>
        <div class="g2">
          <div class="f"><label>Horario Acta 1</label><input type="text" id="horario_acta1" placeholder="13:23"></div>
          <div class="f"><label>Horario Acta 2</label><input type="text" id="horario_acta2" placeholder="14:19"></div>
        </div>
        <div class="g3">
          <div class="f"><label>D√≠a</label><input type="number" id="dia" min="1" max="31"></div>
          <div class="f"><label>Mes</label><input type="text" id="mes" placeholder="ENERO"></div>
          <div class="f"><label>A√±o</label><input type="number" id="anio" min="2020"></div>
        </div>
      </div>
    </div>

    <!-- UBICACI√ìN -->
    <div class="tc" id="tUbi">
      <div class="sec"><div class="sec-title">Direcci√≥n</div>
        <div class="f"><label>Calle</label><input type="text" id="calle"></div>
        <div class="g2">
          <div class="f"><label>No. Exterior</label><input type="text" id="no_exterior"></div>
          <div class="f"><label>C.P.</label><input type="number" id="codigo_postal"></div>
        </div>
        <div class="f"><label>Colonia / Barrio</label><input type="text" id="colonia_barrio"></div>
        <div class="g2">
          <div class="f"><label>Municipio</label><input type="text" id="municipio"></div>
          <div class="f"><label>Estado</label><input type="text" id="estado"></div>
        </div>
        <div class="f"><label>Coordenadas GPS</label><input type="text" id="coordenadas" placeholder="lat, lng"></div>
        <button onclick="gps()" style="background:var(--surface2);border:1px solid var(--border);color:var(--text2);padding:8px 14px;border-radius:6px;font-family:var(--mono);font-size:11px;cursor:pointer;margin-bottom:14px;">üìç Obtener GPS actual</button>
      </div>
      <div class="sec"><div class="sec-title">Colindancias</div>
        <div class="f"><label>Norte</label><input type="text" id="norte"></div>
        <div class="f"><label>Sur</label><input type="text" id="sur"></div>
        <div class="f"><label>Este</label><input type="text" id="este"></div>
        <div class="f"><label>Oeste</label><input type="text" id="oeste"></div>
        <div class="f"><label>Referencia para llegar</label><textarea id="referencia_llegar"></textarea></div>
      </div>
    </div>

    <!-- INVENTARIO -->
    <div class="tc" id="tInv">
      <div class="sec"><div class="sec-title">Accesos y Salidas <span class="bdg f">CAMPO</span></div>
        <div class="g2">
          <div class="f fi"><label>Accesos</label><div class="cw fi"><button class="cb" onclick="cnt('accesos',-1)">‚àí</button><input class="ci" type="number" id="accesos" value="0" min="0"><button class="cb" onclick="cnt('accesos',1)">+</button></div></div>
          <div class="f fi"><label>Salidas Emergencia</label><div class="cw fi"><button class="cb" onclick="cnt('salidas_emergencia',-1)">‚àí</button><input class="ci" type="number" id="salidas_emergencia" value="0" min="0"><button class="cb" onclick="cnt('salidas_emergencia',1)">+</button></div></div>
        </div>
        <div class="g2">
          <div class="f fi"><label>Escaleras</label><div class="cw fi"><button class="cb" onclick="cnt('escaleras',-1)">‚àí</button><input class="ci" type="number" id="escaleras" value="0" min="0"><button class="cb" onclick="cnt('escaleras',1)">+</button></div></div>
          <div class="f fi"><label>Escaleras Emergencia</label><div class="cw fi"><button class="cb" onclick="cnt('escaleras_emergencia',-1)">‚àí</button><input class="ci" type="number" id="escaleras_emergencia" value="0" min="0"><button class="cb" onclick="cnt('escaleras_emergencia',1)">+</button></div></div>
        </div>
      </div>
      <div class="sec"><div class="sec-title">Extintores <span class="bdg f">CAMPO</span></div>
        <div class="g2">
          <div class="f fi"><label>PQS</label><div class="cw fi"><button class="cb" onclick="cnt('extintor_pqs',-1)">‚àí</button><input class="ci" type="number" id="extintor_pqs" min="0"><button class="cb" onclick="cnt('extintor_pqs',1)">+</button></div></div>
          <div class="f fi"><label>CO‚ÇÇ</label><div class="cw fi"><button class="cb" onclick="cnt('extintor_co2',-1)">‚àí</button><input class="ci" type="number" id="extintor_co2" min="0"><button class="cb" onclick="cnt('extintor_co2',1)">+</button></div></div>
        </div>
        <div class="f fi"><label>Mantenimiento Extintores</label><input type="text" id="mantto_ext" placeholder="ej. ENERO 2025"></div>
        <div class="f fi"><label>Ubicaci√≥n Extintores</label><textarea id="ubicacion_extintores"></textarea></div>
      </div>
      <div class="sec"><div class="sec-title">Alarmas <span class="bdg f">CAMPO</span></div>
        <div class="f fi"><label>Cantidad</label><div class="cw fi"><button class="cb" onclick="cnt('alarmas',-1)">‚àí</button><input class="ci" type="number" id="alarmas" value="0" min="0"><button class="cb" onclick="cnt('alarmas',1)">+</button></div></div>
        <div class="f fi"><label>Tipo de Alarma</label><input type="text" id="tipo_alarma"></div>
        <div class="f fi"><label>Ubicaci√≥n Alarmas</label><textarea id="ubicacion_alarma"></textarea></div>
      </div>
      <div class="sec"><div class="sec-title">Detectores de Humo <span class="bdg f">CAMPO</span></div>
        <div class="f fi"><label>Cantidad</label><div class="cw fi"><button class="cb" onclick="cnt('detectores_humo',-1)">‚àí</button><input class="ci" type="number" id="detectores_humo" value="0" min="0"><button class="cb" onclick="cnt('detectores_humo',1)">+</button></div></div>
        <div class="f fi"><label>Ubicaci√≥n</label><textarea id="ubicacion_dh"></textarea></div>
      </div>
      <div class="sec"><div class="sec-title">L√°mparas Emergencia <span class="bdg f">CAMPO</span></div>
        <div class="f fi"><label>Cantidad</label><div class="cw fi"><button class="cb" onclick="cnt('lamparas_emergencia',-1)">‚àí</button><input class="ci" type="number" id="lamparas_emergencia" value="0" min="0"><button class="cb" onclick="cnt('lamparas_emergencia',1)">+</button></div></div>
        <div class="f fi"><label>Ubicaci√≥n</label><textarea id="ubicacion_lamparas_emergencia"></textarea></div>
      </div>
      <div class="sec"><div class="sec-title">Botiqu√≠n <span class="bdg f">CAMPO</span></div>
        <div class="f fi"><label>Cantidad</label><div class="cw fi"><button class="cb" onclick="cnt('botiquin_emergencia',-1)">‚àí</button><input class="ci" type="number" id="botiquin_emergencia" value="0" min="0"><button class="cb" onclick="cnt('botiquin_emergencia',1)">+</button></div></div>
        <div class="f fi"><label>Ubicaci√≥n</label><textarea id="ubicacion_botiquin"></textarea></div>
      </div>
    </div>

    <!-- SE√ëALES -->
    <div class="tc" id="tSen">
      <div class="sec"><div class="sec-title">Evacuaci√≥n <span class="bdg f">CAMPO</span></div>
        <div class="g2">
          <div class="f fi"><label>Ruta Evacuaci√≥n</label><div class="cw fi"><button class="cb" onclick="cnt('ruta_evacuacion',-1)">‚àí</button><input class="ci" type="number" id="ruta_evacuacion" value="0" min="0"><button class="cb" onclick="cnt('ruta_evacuacion',1)">+</button></div></div>
          <div class="f fi"><label>Salida Emergencia</label><div class="cw fi"><button class="cb" onclick="cnt('salida_emergencia',-1)">‚àí</button><input class="ci" type="number" id="salida_emergencia" value="0" min="0"><button class="cb" onclick="cnt('salida_emergencia',1)">+</button></div></div>
          <div class="f fi"><label>Punto de Reuni√≥n</label><div class="cw fi"><button class="cb" onclick="cnt('punto_reunion',-1)">‚àí</button><input class="ci" type="number" id="punto_reunion" value="0" min="0"><button class="cb" onclick="cnt('punto_reunion',1)">+</button></div></div>
          <div class="f fi"><label>Sismo / Incendio</label><div class="cw fi"><button class="cb" onclick="cnt('sismo_incendio',-1)">‚àí</button><input class="ci" type="number" id="sismo_incendio" value="0" min="0"><button class="cb" onclick="cnt('sismo_incendio',1)">+</button></div></div>
          <div class="f fi"><label>Se√±al Escaleras</label><div class="cw fi"><button class="cb" onclick="cnt('se√±al_escaleras',-1)">‚àí</button><input class="ci" type="number" id="se√±al_escaleras" value="0" min="0"><button class="cb" onclick="cnt('se√±al_escaleras',1)">+</button></div></div>
          <div class="f fi"><label>Zona Menor Riesgo</label><div class="cw fi"><button class="cb" onclick="cnt('zona_menor_riesgo',-1)">‚àí</button><input class="ci" type="number" id="zona_menor_riesgo" value="0" min="0"><button class="cb" onclick="cnt('zona_menor_riesgo',1)">+</button></div></div>
        </div>
      </div>
      <div class="sec"><div class="sec-title">Prevenci√≥n <span class="bdg f">CAMPO</span></div>
        <div class="g2">
          <div class="f fi"><label>Riesgo El√©ctrico</label><div class="cw fi"><button class="cb" onclick="cnt('riesgo_electrico',-1)">‚àí</button><input class="ci" type="number" id="riesgo_electrico" value="0" min="0"><button class="cb" onclick="cnt('riesgo_electrico',1)">+</button></div></div>
          <div class="f fi"><label>√Årea Restringida</label><div class="cw fi"><button class="cb" onclick="cnt('area_restringida',-1)">‚àí</button><input class="ci" type="number" id="area_restringida" value="0" min="0"><button class="cb" onclick="cnt('area_restringida',1)">+</button></div></div>
          <div class="f fi"><label>No Fumar</label><div class="cw fi"><button class="cb" onclick="cnt('no_fumar',-1)">‚àí</button><input class="ci" type="number" id="no_fumar" value="0" min="0"><button class="cb" onclick="cnt('no_fumar',1)">+</button></div></div>
          <div class="f fi"><label>No Celular</label><div class="cw fi"><button class="cb" onclick="cnt('no_celular',-1)">‚àí</button><input class="ci" type="number" id="no_celular" value="0" min="0"><button class="cb" onclick="cnt('no_celular',1)">+</button></div></div>
          <div class="f fi"><label>No Gorra</label><div class="cw fi"><button class="cb" onclick="cnt('no_gorra',-1)">‚àí</button><input class="ci" type="number" id="no_gorra" value="0" min="0"><button class="cb" onclick="cnt('no_gorra',1)">+</button></div></div>
          <div class="f fi"><label>No Lentes</label><div class="cw fi"><button class="cb" onclick="cnt('no_lentes',-1)">‚àí</button><input class="ci" type="number" id="no_lentes" value="0" min="0"><button class="cb" onclick="cnt('no_lentes',1)">+</button></div></div>
          <div class="f fi"><label>No Estacionarse</label><div class="cw fi"><button class="cb" onclick="cnt('no_estacionarse',-1)">‚àí</button><input class="ci" type="number" id="no_estacionarse" value="0" min="0"><button class="cb" onclick="cnt('no_estacionarse',1)">+</button></div></div>
          <div class="f fi"><label>Est. Discapacidad</label><div class="cw fi"><button class="cb" onclick="cnt('estacionamiento_discapacidad',-1)">‚àí</button><input class="ci" type="number" id="estacionamiento_discapacidad" value="0" min="0"><button class="cb" onclick="cnt('estacionamiento_discapacidad',1)">+</button></div></div>
          <div class="f fi"><label>Rampa Discapacidad</label><div class="cw fi"><button class="cb" onclick="cnt('rampa_discapacidad',-1)">‚àí</button><input class="ci" type="number" id="rampa_discapacidad" value="0" min="0"><button class="cb" onclick="cnt('rampa_discapacidad',1)">+</button></div></div>
          <div class="f fi"><label>Velocidad M√°x.</label><div class="cw fi"><button class="cb" onclick="cnt('velocidad_max',-1)">‚àí</button><input class="ci" type="number" id="velocidad_max" value="0" min="0"><button class="cb" onclick="cnt('velocidad_max',1)">+</button></div></div>
        </div>
      </div>
    </div>

    <!-- RIESGOS -->
    <div class="tc" id="tRie">
      <div class="sec"><div class="sec-title">Riesgos Colindantes</div>
        <div class="f"><label>Riesgo Bajo 1</label><input type="text" id="riesgo_bajo1"></div>
        <div class="f"><label>Riesgo Bajo 2</label><input type="text" id="riesgo_bajo2"></div>
        <div class="f"><label>Riesgo Bajo 3</label><input type="text" id="riesgo_bajo3"></div>
        <div class="f"><label>Riesgo Medio 1</label><input type="text" id="riesgo_medio1"></div>
        <div class="f"><label>Riesgo Medio 2</label><input type="text" id="riesgo_medio2"></div>
        <div class="f"><label>Riesgo Medio 3</label><input type="text" id="riesgo_medio3"></div>
        <div class="f"><label>Riesgo Alto 1</label><input type="text" id="riesgo_alto1"></div>
        <div class="f"><label>Riesgo Alto 2</label><input type="text" id="riesgo_alto2"></div>
        <div class="f"><label>Riesgo Alto 3</label><input type="text" id="riesgo_alto3"></div>
      </div>
      <div class="sec"><div class="sec-title">Materiales Peligrosos</div>
        <div class="f"><label>Cocina</label><select id="cocina"><option value="NO">NO</option><option value="S√ç">S√ç</option></select></div>
        <div class="f"><label>Desc. Gas / Inflamable</label><textarea id="descripcion_gas_inflamable"></textarea></div>
        <div class="f"><label>Gas Inflamable (kg/lt)</label><input type="number" id="gas_inflamable" min="0"></div>
        <div class="f"><label>Desc. L√≠quido Inflamable</label><textarea id="descripcion_liquido_inflamable"></textarea></div>
        <div class="f"><label>L√≠quido Inflamable (lt)</label><input type="number" id="liquido_inflamable" min="0"></div>
        <div class="f"><label>Desc. L√≠quido Combustible</label><textarea id="descripcion_liquido_combustible"></textarea></div>
        <div class="f"><label>L√≠quido Combustible (lt)</label><input type="number" id="liquido_combustible" min="0"></div>
        <div class="f"><label>Desc. S√≥lido Combustible</label><textarea id="descripcion_solido_combustible"></textarea></div>
        <div class="f"><label>S√≥lido Combustible (kg)</label><input type="number" id="solido_combustible" min="0"></div>
      </div>
    </div>

    <!-- POBLACI√ìN -->
    <div class="tc" id="tPob">
      <div class="sec"><div class="sec-title">Personal por G√©nero</div>
        <div class="g2">
          <div class="f"><label>Hombres</label><input type="number" id="hombres" min="0"></div>
          <div class="f"><label>Mujeres</label><input type="number" id="mujeres" min="0"></div>
        </div>
      </div>
      <div class="sec"><div class="sec-title">Personal por Turno</div>
        <div class="g3">
          <div class="f"><label>Turno 1</label><input type="number" id="turno_1" min="0"></div>
          <div class="f"><label>Turno 2</label><input type="number" id="turno_2" min="0"></div>
          <div class="f"><label>Turno 3</label><input type="number" id="turno_3" min="0"></div>
        </div>
        <div class="g2">
          <div class="f"><label>Visitantes</label><input type="number" id="visitantes" min="0"></div>
          <div class="f"><label>Proveedores</label><input type="number" id="proveedores" min="0"></div>
        </div>
      </div>
      <div class="sec"><div class="sec-title">Representantes</div>
        <div class="f"><label>Representante Legal</label><input type="text" id="representante_legal"></div>
        <div class="f"><label>Coordinador</label><input type="text" id="coordinador"></div>
        <div class="f"><label>Puesto Coordinador</label><input type="text" id="puesto_coordinador"></div>
        <div class="f"><label>M. Director</label><input type="text" id="m_director"></div>
        <div class="f"><label>Coordinador Suplente</label><input type="text" id="coord_suplente"></div>
        <div class="f"><label>Puesto Coord. Suplente</label><input type="text" id="puesto_coord_suplente"></div>
        <div class="f"><label>M. Coord. Suplente</label><input type="text" id="m_coord_suplente"></div>
      </div>
    </div>

    <!-- BRIGADAS -->
    <div class="tc" id="tBri">
      <div class="sec"><div class="sec-title">Brigada de Incendios</div>
        <div class="brig"><div class="brig-t">Titular</div>
          <div class="f"><label>Nombre</label><input type="text" id="incendios"></div>
          <div class="f"><label>Puesto</label><input type="text" id="incendios_puesto"></div>
          <div class="f"><label>M. Incendios</label><input type="text" id="m_incendios"></div>
        </div>
        <div class="brig"><div class="brig-t">Suplente</div>
          <div class="f"><label>Nombre</label><input type="text" id="suplente_incendios"></div>
          <div class="f"><label>Puesto</label><input type="text" id="puesto_suplente_incendios"></div>
          <div class="f"><label>M. Suplente</label><input type="text" id="m_suplente_incendios"></div>
        </div>
      </div>
      <div class="sec"><div class="sec-title">Brigada Primeros Auxilios</div>
        <div class="brig"><div class="brig-t">Titular</div>
          <div class="f"><label>Nombre</label><input type="text" id="primeros_auxilios"></div>
          <div class="f"><label>Puesto</label><input type="text" id="puesto_primeros_auxilios"></div>
          <div class="f"><label>M. Primeros Auxilios</label><input type="text" id="m_primeros_auxilios"></div>
        </div>
        <div class="brig"><div class="brig-t">Suplente</div>
          <div class="f"><label>Nombre</label><input type="text" id="suplente_primeros_auxilios"></div>
          <div class="f"><label>Puesto</label><input type="text" id="puesto_suplente_primeros_auxilios"></div>
          <div class="f"><label>M. Suplente</label><input type="text" id="m_suplente_primeros_auxilios"></div>
        </div>
      </div>
      <div class="sec"><div class="sec-title">Brigada de Evacuaci√≥n</div>
        <div class="brig"><div class="brig-t">Titular</div>
          <div class="f"><label>Nombre</label><input type="text" id="evacuacion"></div>
          <div class="f"><label>Puesto</label><input type="text" id="puesto_evacuacion"></div>
          <div class="f"><label>M. Evacuaci√≥n</label><input type="text" id="m_evacuacion"></div>
        </div>
        <div class="brig"><div class="brig-t">Suplente</div>
          <div class="f"><label>Nombre</label><input type="text" id="suplente_evacuacion"></div>
          <div class="f"><label>Puesto</label><input type="text" id="puesto_suplente_evacuacion"></div>
          <div class="f"><label>M. Suplente</label><input type="text" id="m_suplente_evacuacion"></div>
        </div>
      </div>
      <div class="sec"><div class="sec-title">Brigada B√∫squeda y Rescate</div>
        <div class="brig"><div class="brig-t">Titular</div>
          <div class="f"><label>Nombre</label><input type="text" id="busqueda"></div>
          <div class="f"><label>Puesto</label><input type="text" id="puesto_busqueda"></div>
          <div class="f"><label>M. B√∫squeda</label><input type="text" id="m_busqueda"></div>
        </div>
        <div class="brig"><div class="brig-t">Suplente</div>
          <div class="f"><label>Nombre</label><input type="text" id="suplente_busqueda"></div>
          <div class="f"><label>Puesto</label><input type="text" id="puesto_suplente_busqueda"></div>
          <div class="f"><label>M. Suplente</label><input type="text" id="m_suplente_busqueda"></div>
        </div>
      </div>
    </div>


    <!-- FOTOS -->
    <div class="tc" id="tFotos">
      <!-- Barra ZIP fija -->
      <div style="background:var(--surface);border:1px solid var(--accent);border-radius:var(--radius);padding:14px;margin-bottom:16px;position:sticky;top:58px;z-index:50;">
        <div style="font-family:var(--mono);font-size:10px;color:var(--text2);margin-bottom:8px;" id="lblFotosZip">Selecciona fotos para generar el ZIP</div>
        <button id="btnDescargaZip" onclick="descargarZip()" disabled
          style="width:100%;background:var(--accent);border:none;color:#000;padding:11px;border-radius:6px;
                 font-family:var(--mono);font-size:12px;font-weight:600;cursor:pointer;letter-spacing:1px;">
          üì¶ DESCARGAR ZIP
        </button>

      </div>

      <!-- INDIVIDUALES -->
      <div class="sec"><div class="sec-title" style="color:var(--accent2)">Fotos individuales <span class="bdg f">C√ÅMARA / GALER√çA</span></div>
        <p style="font-size:11px;color:var(--text2);font-family:var(--mono);margin-bottom:12px;line-height:1.6;">
          Toca el cuadro ‚Üí elige c√°mara o galer√≠a ‚Üí queda en memoria.
        </p>
      </div>
      <div class="sec"><div class="sec-title">Fachada / Exterior</div>
        <div class="foto-grid">
<div class="foto-slot" id="slot_fachada" onclick="selectFoto('fachada','fachada.jpg')"><div class="foto-icon">üì∑</div><img class="foto-thumb" id="thumb_fachada"><div class="foto-name">fachada.jpg</div></div>
<div class="foto-slot" id="slot_fachada1" onclick="selectFoto('fachada1','fachada1.jpg')"><div class="foto-icon">üì∑</div><img class="foto-thumb" id="thumb_fachada1"><div class="foto-name">fachada1.jpg</div></div>
<div class="foto-slot" id="slot_bardas" onclick="selectFoto('bardas','bardas.jpg')"><div class="foto-icon">üì∑</div><img class="foto-thumb" id="thumb_bardas"><div class="foto-name">bardas.jpg</div></div>
<div class="foto-slot" id="slot_plano" onclick="selectFoto('plano','plano.jpg')"><div class="foto-icon">üì∑</div><img class="foto-thumb" id="thumb_plano"><div class="foto-name">plano.jpg</div></div>
        </div>
      </div>
      <div class="sec"><div class="sec-title">Interior</div>
        <div class="foto-grid">
<div class="foto-slot" id="slot_site" onclick="selectFoto('site','site.jpg')"><div class="foto-icon">üì∑</div><img class="foto-thumb" id="thumb_site"><div class="foto-name">site.jpg</div></div>
<div class="foto-slot" id="slot_atencion_clientes" onclick="selectFoto('atencion_clientes','atencion_clientes.jpg')"><div class="foto-icon">üì∑</div><img class="foto-thumb" id="thumb_atencion_clientes"><div class="foto-name">atencion_clientes.jpg</div></div>
<div class="foto-slot" id="slot_puerta" onclick="selectFoto('puerta','puerta.jpg')"><div class="foto-icon">üì∑</div><img class="foto-thumb" id="thumb_puerta"><div class="foto-name">puerta.jpg</div></div>
<div class="foto-slot" id="slot_ventanas" onclick="selectFoto('ventanas','ventanas.jpg')"><div class="foto-icon">üì∑</div><img class="foto-thumb" id="thumb_ventanas"><div class="foto-name">ventanas.jpg</div></div>
<div class="foto-slot" id="slot_estantes" onclick="selectFoto('estantes','estantes.jpg')"><div class="foto-icon">üì∑</div><img class="foto-thumb" id="thumb_estantes"><div class="foto-name">estantes.jpg</div></div>
        </div>
      </div>
      <div class="sec"><div class="sec-title">Instalaciones</div>
        <div class="foto-grid">
<div class="foto-slot" id="slot_salida" onclick="selectFoto('salida','salida.jpg')"><div class="foto-icon">üì∑</div><img class="foto-thumb" id="thumb_salida"><div class="foto-name">salida.jpg</div></div>
<div class="foto-slot" id="slot_valvulas" onclick="selectFoto('valvulas','valvulas.jpg')"><div class="foto-icon">üì∑</div><img class="foto-thumb" id="thumb_valvulas"><div class="foto-name">valvulas.jpg</div></div>
<div class="foto-slot" id="slot_paro" onclick="selectFoto('paro','paro.jpg')"><div class="foto-icon">üì∑</div><img class="foto-thumb" id="thumb_paro"><div class="foto-name">paro.jpg</div></div>
<div class="foto-slot" id="slot_planta" onclick="selectFoto('planta','planta.jpg')"><div class="foto-icon">üì∑</div><img class="foto-thumb" id="thumb_planta"><div class="foto-name">planta.jpg</div></div>
<div class="foto-slot" id="slot_deposito" onclick="selectFoto('deposito','deposito.jpg')"><div class="foto-icon">üì∑</div><img class="foto-thumb" id="thumb_deposito"><div class="foto-name">deposito.jpg</div></div>
<div class="foto-slot" id="slot_trampa_grasa" onclick="selectFoto('trampa_grasa','trampa_grasa.jpg')"><div class="foto-icon">üì∑</div><img class="foto-thumb" id="thumb_trampa_grasa"><div class="foto-name">trampa_grasa.jpg</div></div>
<div class="foto-slot" id="slot_compresor" onclick="selectFoto('compresor','compresor.jpg')"><div class="foto-icon">üì∑</div><img class="foto-thumb" id="thumb_compresor"><div class="foto-name">compresor.jpg</div></div>
<div class="foto-slot" id="slot_quimicos" onclick="selectFoto('quimicos','quimicos.jpg')"><div class="foto-icon">üì∑</div><img class="foto-thumb" id="thumb_quimicos"><div class="foto-name">quimicos.jpg</div></div>
<div class="foto-slot" id="slot_caldera" onclick="selectFoto('caldera','caldera.jpg')"><div class="foto-icon">üì∑</div><img class="foto-thumb" id="thumb_caldera"><div class="foto-name">caldera.jpg</div></div>
<div class="foto-slot" id="slot_bombas" onclick="selectFoto('bombas','bombas.jpg')"><div class="foto-icon">üì∑</div><img class="foto-thumb" id="thumb_bombas"><div class="foto-name">bombas.jpg</div></div>
<div class="foto-slot" id="slot_hidrante" onclick="selectFoto('hidrante','hidrante.jpg')"><div class="foto-icon">üì∑</div><img class="foto-thumb" id="thumb_hidrante"><div class="foto-name">hidrante.jpg</div></div>
<div class="foto-slot" id="slot_bomberos" onclick="selectFoto('bomberos','bomberos.jpg')"><div class="foto-icon">üì∑</div><img class="foto-thumb" id="thumb_bomberos"><div class="foto-name">bomberos.jpg</div></div>
<div class="foto-slot" id="slot_brigadas" onclick="selectFoto('brigadas','brigadas.jpg')"><div class="foto-icon">üì∑</div><img class="foto-thumb" id="thumb_brigadas"><div class="foto-name">brigadas.jpg</div></div>
<div class="foto-slot" id="slot_punto_reun" onclick="selectFoto('punto_reun','punto_reun.jpg')"><div class="foto-icon">üì∑</div><img class="foto-thumb" id="thumb_punto_reun"><div class="foto-name">punto_reun.jpg</div></div>
        </div>
      </div>

      <!-- LOTES -->
      <div class="sec" style="margin-top:8px"><div class="sec-title" style="color:var(--accent2)">Fotos en lote <span class="bdg f">SELECCI√ìN M√öLTIPLE</span></div>
        <p style="font-size:11px;color:var(--text2);font-family:var(--mono);margin-bottom:12px;line-height:1.6;">
          Selecciona varias fotos a la vez. Se nombran autom√°ticamente en el orden que las elijas.
        </p>
      </div>
      <div class="sec"><div class="sec-title">Interior / Inmueble</div>
      <div class="bulk-box">
          <div class="bulk-header">
            <span class="bulk-label">Inmueble (1‚Äì4)</span>
            <span class="bulk-count" id="cnt_inmueble">0 sel.</span>
          </div>
          <button class="btn-bulk" onclick="selectBulk('inmueble','inmueble',4)">üìÇ Inmueble (1‚Äì4)</button>
          <div class="bulk-thumbs" id="thumbs_inmueble"></div>
        </div>
      <div class="bulk-box">
          <div class="bulk-header">
            <span class="bulk-label">Mueble (1‚Äì4)</span>
            <span class="bulk-count" id="cnt_mueble">0 sel.</span>
          </div>
          <button class="btn-bulk" onclick="selectBulk('mueble','mueble',4)">üìÇ Mueble (1‚Äì4)</button>
          <div class="bulk-thumbs" id="thumbs_mueble"></div>
        </div>

      </div>
      <div class="sec"><div class="sec-title">Contra Incendio y Se√±alamientos</div>
      <div class="bulk-box">
          <div class="bulk-header">
            <span class="bulk-label">Extintores (1‚Äì6)</span>
            <span class="bulk-count" id="cnt_ext">0 sel.</span>
          </div>
          <button class="btn-bulk" onclick="selectBulk('ext','ext',6)">üìÇ Extintores (1‚Äì6)</button>
          <div class="bulk-thumbs" id="thumbs_ext"></div>
        </div>
      <div class="bulk-box">
          <div class="bulk-header">
            <span class="bulk-label">Alarmas (1‚Äì2)</span>
            <span class="bulk-count" id="cnt_alarma">0 sel.</span>
          </div>
          <button class="btn-bulk" onclick="selectBulkSufijo('alarma','alarma',2)">üìÇ Alarmas (1‚Äì2)</button>
          <div class="bulk-thumbs" id="thumbs_alarma"></div>
        </div>
      <div class="bulk-box">
          <div class="bulk-header">
            <span class="bulk-label">Det. Humo (1‚Äì2)</span>
            <span class="bulk-count" id="cnt_dh">0 sel.</span>
          </div>
          <button class="btn-bulk" onclick="selectBulkSufijo('dh','dh',2)">üìÇ Det. Humo (1‚Äì2)</button>
          <div class="bulk-thumbs" id="thumbs_dh"></div>
        </div>
      <div class="bulk-box">
          <div class="bulk-header">
            <span class="bulk-label">L√°mparas (1‚Äì2)</span>
            <span class="bulk-count" id="cnt_lampara">0 sel.</span>
          </div>
          <button class="btn-bulk" onclick="selectBulkSufijo('lampara','lampara',2)">üìÇ L√°mparas (1‚Äì2)</button>
          <div class="bulk-thumbs" id="thumbs_lampara"></div>
        </div>
      <div class="bulk-box">
          <div class="bulk-header">
            <span class="bulk-label">Botiqu√≠n (1‚Äì2)</span>
            <span class="bulk-count" id="cnt_botiquin">0 sel.</span>
          </div>
          <button class="btn-bulk" onclick="selectBulkSufijo('botiquin','botiquin',2)">üìÇ Botiqu√≠n (1‚Äì2)</button>
          <div class="bulk-thumbs" id="thumbs_botiquin"></div>
        </div>
      <div class="bulk-box">
          <div class="bulk-header">
            <span class="bulk-label">Esc. Emergencia (1‚Äì2)</span>
            <span class="bulk-count" id="cnt_esc_emer">0 sel.</span>
          </div>
          <button class="btn-bulk" onclick="selectBulkSufijo('esc_emer','esc_emer',2)">üìÇ Esc. Emergencia (1‚Äì2)</button>
          <div class="bulk-thumbs" id="thumbs_esc_emer"></div>
        </div>
      <div class="bulk-box">
          <div class="bulk-header">
            <span class="bulk-label">Rutas (1‚Äì4)</span>
            <span class="bulk-count" id="cnt_ruta">0 sel.</span>
          </div>
          <button class="btn-bulk" onclick="selectBulk('ruta','ruta',4)">üìÇ Rutas (1‚Äì4)</button>
          <div class="bulk-thumbs" id="thumbs_ruta"></div>
        </div>
      <div class="bulk-box">
          <div class="bulk-header">
            <span class="bulk-label">Prohibiciones (1‚Äì4)</span>
            <span class="bulk-count" id="cnt_prohib">0 sel.</span>
          </div>
          <button class="btn-bulk" onclick="selectBulk('prohib','prohib',4)">üìÇ Prohibiciones (1‚Äì4)</button>
          <div class="bulk-thumbs" id="thumbs_prohib"></div>
        </div>
      <div class="bulk-box">
          <div class="bulk-header">
            <span class="bulk-label">Zona Segura (1‚Äì2)</span>
            <span class="bulk-count" id="cnt_zona_sec">0 sel.</span>
          </div>
          <button class="btn-bulk" onclick="selectBulkSufijo('zona_sec','zona_sec',2)">üìÇ Zona Segura (1‚Äì2)</button>
          <div class="bulk-thumbs" id="thumbs_zona_sec"></div>
        </div>
      <div class="bulk-box">
          <div class="bulk-header">
            <span class="bulk-label">Sis. Incendio (1‚Äì2)</span>
            <span class="bulk-count" id="cnt_sis_inc">0 sel.</span>
          </div>
          <button class="btn-bulk" onclick="selectBulkSufijo('sis_inc','sis_inc',2)">üìÇ Sis. Incendio (1‚Äì2)</button>
          <div class="bulk-thumbs" id="thumbs_sis_inc"></div>
        </div>
      </div>
      <div class="sec"><div class="sec-title">Estructura e Instalaciones</div>
      <div class="bulk-box">
          <div class="bulk-header">
            <span class="bulk-label">Techo (1‚Äì2)</span>
            <span class="bulk-count" id="cnt_techo">0 sel.</span>
          </div>
          <button class="btn-bulk" onclick="selectBulkSufijo('techo','techo',2)">üìÇ Techo (1‚Äì2)</button>
          <div class="bulk-thumbs" id="thumbs_techo"></div>
        </div>
      <div class="bulk-box">
          <div class="bulk-header">
            <span class="bulk-label">Pisos (1‚Äì2)</span>
            <span class="bulk-count" id="cnt_pisos">0 sel.</span>
          </div>
          <button class="btn-bulk" onclick="selectBulkSufijo('pisos','pisos',2)">üìÇ Pisos (1‚Äì2)</button>
          <div class="bulk-thumbs" id="thumbs_pisos"></div>
        </div>
      <div class="bulk-box">
          <div class="bulk-header">
            <span class="bulk-label">Ba√±o (1‚Äì2)</span>
            <span class="bulk-count" id="cnt_banio">0 sel.</span>
          </div>
          <button class="btn-bulk" onclick="selectBulkSufijo('banio','banio',2)">üìÇ Ba√±o (1‚Äì2)</button>
          <div class="bulk-thumbs" id="thumbs_banio"></div>
        </div>
      <div class="bulk-box">
          <div class="bulk-header">
            <span class="bulk-label">El√©ctrico (1‚Äì2)</span>
            <span class="bulk-count" id="cnt_electrico">0 sel.</span>
          </div>
          <button class="btn-bulk" onclick="selectBulkSufijo('electrico','electrico',2)">üìÇ El√©ctrico (1‚Äì2)</button>
          <div class="bulk-thumbs" id="thumbs_electrico"></div>
        </div>
      <div class="bulk-box">
          <div class="bulk-header">
            <span class="bulk-label">Tanques Gas (1‚Äì2)</span>
            <span class="bulk-count" id="cnt_tanques_gaso">0 sel.</span>
          </div>
          <button class="btn-bulk" onclick="selectBulkSufijo('tanques_gaso','tanques_gaso',2)">üìÇ Tanques Gas (1‚Äì2)</button>
          <div class="bulk-thumbs" id="thumbs_tanques_gaso"></div>
        </div>
      <div class="bulk-box">
          <div class="bulk-header">
            <span class="bulk-label">Planes (1‚Äì3)</span>
            <span class="bulk-count" id="cnt_plan">0 sel.</span>
          </div>
          <button class="btn-bulk" onclick="selectBulk('plan','plan',3)">üìÇ Planes (1‚Äì3)</button>
          <div class="bulk-thumbs" id="thumbs_plan"></div>
        </div>
      </div>
      <div class="sec"><div class="sec-title">Capacitaciones y Simulacros</div>
      <div class="bulk-box">
          <div class="bulk-header">
            <span class="bulk-label">Capacitaciones (1‚Äì24)</span>
            <span class="bulk-count" id="cnt_cap">0 sel.</span>
          </div>
          <button class="btn-bulk" onclick="selectBulk('cap','cap',24)">üìÇ Capacitaciones (1‚Äì24)</button>
          <div class="bulk-thumbs" id="thumbs_cap"></div>
        </div>
      <div class="bulk-box">
          <div class="bulk-header">
            <span class="bulk-label">Simulacros (1‚Äì12)</span>
            <span class="bulk-count" id="cnt_sim">0 sel.</span>
          </div>
          <button class="btn-bulk" onclick="selectBulk('sim','sim',12)">üìÇ Simulacros (1‚Äì12)</button>
          <div class="bulk-thumbs" id="thumbs_sim"></div>
        </div>
      <div class="bulk-box">
          <div class="bulk-header">
            <span class="bulk-label">Estructuras (1‚Äì18)</span>
            <span class="bulk-count" id="cnt_est">0 sel.</span>
          </div>
          <button class="btn-bulk" onclick="selectBulk('est','est',18)">üìÇ Estructuras (1‚Äì18)</button>
          <div class="bulk-thumbs" id="thumbs_est"></div>
        </div>
      <div class="bulk-box">
          <div class="bulk-header">
            <span class="bulk-label">Electricidad (1‚Äì12)</span>
            <span class="bulk-count" id="cnt_ele">0 sel.</span>
          </div>
          <button class="btn-bulk" onclick="selectBulk('ele','ele',12)">üìÇ Electricidad (1‚Äì12)</button>
          <div class="bulk-thumbs" id="thumbs_ele"></div>
        </div>
      </div>
    </div>

    <!-- FIRMA -->
    <div class="tc" id="tFirma">
      <div class="sec"><div class="sec-title" style="color:var(--accent2)">Firma digital ‚úçÔ∏è</div>
        <p style="font-size:11px;color:var(--text2);font-family:var(--mono);margin-bottom:14px;line-height:1.6;">
          Firma con el dedo o el l√°piz. Se guardar√° como <b style="color:var(--text)">firma.png</b> y se incluir√° en el ZIP del sitio.
        </p>
        <div class="firma-wrap" id="firmaWrap">
          <canvas id="firmaCanvas"></canvas>
        </div>
        <div class="firma-btns">
          <button class="btn-firma-clear" onclick="firmaClear()">üóë Borrar</button>
          <button class="btn-firma-save" onclick="firmaGuardar()">‚úì Agregar al ZIP</button>
        </div>
        <div class="firma-preview" id="firmaPreview">
          <img id="firmaPreviewImg">
          <div class="firma-ok">‚úì firma.png lista ‚Äî se incluir√° en el ZIP</div>
        </div>
      </div>
    </div>

  </div>
  <div class="bot-bar">
    <button class="btn-back" onclick="volver()">‚Üê Volver</button>
    <button class="btn-save" id="btnSave" onclick="guardar()">üíæ GUARDAR EN AIRTABLE</button>
  </div>
</div>

<script>
// ===== CONFIG =====
const BASE       = 'appy6PazgVEt6DWzU';
const TBL_INM    = 'tblGLidPHPZP7M7ds';
const TBL_POB    = 'tblUf7enRg2f9vpSK';
let APIKEY       = localStorage.getItem('pipc_key') || '';

// ===== CAMPOS =====
const F_INM = [
  'nombre_comercial','Categoria','razon_social','rfc','calle','no_exterior',
  'colonia_barrio','codigo_postal','municipio','estado','giro_comercial',
  'descripcion_actividades','telefono','email','dias_trabajo','horario',
  'turnos','antiguedad_inmueble','inicio_operaciones','edificios','niveles',
  'accesos','salidas_emergencia','escaleras','escaleras_emergencia','estacionamiento',
  'terreno_m2','construccion_m2','coordenadas','norte','sur','este','oeste',
  'referencia_llegar','ruta_evacuacion','salida_emergencia','punto_reunion',
  'sismo_incendio','\u00f1al_escaleras','zona_menor_riesgo','riesgo_electrico',
  'area_restringida','no_fumar','no_celular','no_gorra','no_lentes',
  'no_estacionarse','estacionamiento_discapacidad','rampa_discapacidad','velocidad_max',
  'botiquin_emergencia','ubicacion_botiquin','extintor_pqs','extintor_co2','mantto_ext',
  'ubicacion_extintores','alarmas','tipo_alarma','ubicacion_alarma',
  'detectores_humo','ubicacion_dh','lamparas_emergencia','ubicacion_lamparas_emergencia',
  'horario_acta1','horario_acta2','dia','mes','anio',
  'riesgo_bajo1','riesgo_bajo2','riesgo_bajo3',
  'riesgo_medio1','riesgo_medio2','riesgo_medio3',
  'riesgo_alto1','riesgo_alto2','riesgo_alto3',
  'cocina','descripcion_gas_inflamable','gas_inflamable',
  'descripcion_liquido_inflamable','liquido_inflamable',
  'descripcion_liquido_combustible','liquido_combustible',
  'descripcion_solido_combustible','solido_combustible'
];

// Corregir la √± que se escap√≥
F_INM[F_INM.indexOf('\u00f1al_escaleras')] = 'se\u00f1al_escaleras';

const F_POB = [
  'hombres','mujeres','turno_1','turno_2','turno_3','visitantes','proveedores',
  'representante_legal','coordinador','puesto_coordinador','m_director',
  'coord_suplente','puesto_coord_suplente','m_coord_suplente',
  'incendios','incendios_puesto','m_incendios',
  'suplente_incendios','puesto_suplente_incendios','m_suplente_incendios',
  'primeros_auxilios','puesto_primeros_auxilios','m_primeros_auxilios',
  'suplente_primeros_auxilios','puesto_suplente_primeros_auxilios','m_suplente_primeros_auxilios',
  'evacuacion','puesto_evacuacion','m_evacuacion',
  'suplente_evacuacion','puesto_suplente_evacuacion','m_suplente_evacuacion',
  'busqueda','puesto_busqueda','m_busqueda',
  'suplente_busqueda','puesto_suplente_busqueda','m_suplente_busqueda'
];

const NUM = new Set([
  'turnos','edificios','niveles','accesos','salidas_emergencia','escaleras','escaleras_emergencia',
  'terreno_m2','construccion_m2','codigo_postal','ruta_evacuacion','salida_emergencia',
  'punto_reunion','sismo_incendio','se√±al_escaleras','zona_menor_riesgo','riesgo_electrico',
  'area_restringida','no_fumar','no_celular','no_gorra','no_lentes','no_estacionarse',
  'estacionamiento_discapacidad','rampa_discapacidad','velocidad_max','botiquin_emergencia',
  'extintor_pqs','extintor_co2','alarmas','detectores_humo','lamparas_emergencia',
  'dia','anio','gas_inflamable','liquido_inflamable','liquido_combustible','solido_combustible',
  'hombres','mujeres','turno_1','turno_2','turno_3','visitantes','proveedores'
]);



let recId  = null; // ID registro Inmueble actual
let pobId  = null; // ID registro Poblaci√≥n actual

// ===== API KEY =====
function checkKey() {
  if (!APIKEY) show('sSetup'); else show('sSearch');
}
function saveKey() {
  const v = document.getElementById('iApiKey').value.trim();
  if (!v.startsWith('pat')) { document.getElementById('setupErr').textContent = 'El token debe empezar con "pat"'; return; }
  APIKEY = v;
  localStorage.setItem('pipc_key', v);
  show('sSearch');
}
function changeKey() {
  if (!confirm('¬øCambiar el API Key?')) return;
  localStorage.removeItem('pipc_key');
  location.reload();
}

// ===== API =====
function hdrs() { return { 'Authorization': 'Bearer ' + APIKEY, 'Content-Type': 'application/json' }; }

async function GET(tbl, qs) {
  const r = await fetch('https://api.airtable.com/v0/' + BASE + '/' + tbl + '?' + qs, { headers: hdrs() });
  const d = await r.json();
  if (d.error) throw new Error(d.error.message);
  return d;
}
async function POST(tbl, fields) {
  const r = await fetch('https://api.airtable.com/v0/' + BASE + '/' + tbl, {
    method: 'POST', headers: hdrs(), body: JSON.stringify({ fields: fields })
  });
  const d = await r.json();
  if (d.error) throw new Error(d.error.message);
  return d;
}
async function PATCH(tbl, id, fields) {
  const r = await fetch('https://api.airtable.com/v0/' + BASE + '/' + tbl + '/' + id, {
    method: 'PATCH', headers: hdrs(), body: JSON.stringify({ fields: fields })
  });
  const d = await r.json();
  if (d.error) throw new Error(d.error.message);
  return d;
}

// ===== B√öSQUEDA =====
let srchTmr;
function buscar(q) {
  clearTimeout(srchTmr);
  const list = document.getElementById('resList');
  if (q.length < 2) { list.style.display = 'none'; return; }
  srchTmr = setTimeout(async function() {
    stMsg('Buscando...', 'info');
    try {
      const f = encodeURIComponent('SEARCH("' + q.toUpperCase() + '",UPPER({nombre_comercial}))');
      const d = await GET(TBL_INM, 'filterByFormula=' + f + '&maxRecords=10');
      clrMsg();
      renderRes(d.records || []);
    } catch(e) { stMsg('Error: ' + e.message, 'error'); }
  }, 400);
}

function renderRes(recs) {
  const list = document.getElementById('resList');
  if (!recs.length) { list.style.display = 'none'; return; }
  list.innerHTML = recs.map(function(r) {
    return '<div class="res-item" onclick=\'abrirReg(' + JSON.stringify(r.id) + ',' + JSON.stringify(r.fields) + ')\'>' +
      '<div class="res-name">' + (r.fields.nombre_comercial || '(sin nombre)') + '</div>' +
      '<div class="res-sub">' + (r.fields.municipio || '') + ' ¬∑ ' + (r.fields.estado || '') + '</div>' +
      '</div>';
  }).join('');
  list.style.display = 'block';
}

async function abrirReg(id, fields) {
  recId = id;
  pobId = null;
  limpiar();
  llenarInm(fields);

  // Cargar Poblaci√≥n vinculada al Inmueble
  try {
    var allPob = [];
    var offset = null;
    do {
      var qs = 'pageSize=100' + (offset ? '&offset=' + offset : '');
      var page = await GET(TBL_POB, qs);
      allPob = allPob.concat(page.records || []);
      offset = page.offset || null;
    } while (offset);

    var pobMatch = null;
    allPob.forEach(function(r) {
      Object.keys(r.fields).forEach(function(k) {
        var v = r.fields[k];
        if (Array.isArray(v) && v.indexOf(id) !== -1) pobMatch = r;
      });
    });

    if (pobMatch) {
      pobId = pobMatch.id;
      llenarPob(pobMatch.fields);
    }
  } catch(e) { console.warn('Poblaci√≥n no cargada:', e.message); }

  mostrarForm(fields.nombre_comercial || 'Sitio');
}

function nuevoReg() {
  recId = null; pobId = null;
  limpiar();
  mostrarForm('NUEVO SITIO');
}

// ===== FORM =====
function show(id) {
  document.querySelectorAll('.screen').forEach(function(s) { s.classList.remove('active'); });
  document.getElementById(id).classList.add('active');
}

function mostrarForm(nombre) {
  show('sForm');
  document.getElementById('hSite').innerHTML = '<span>' + nombre + '</span>';
  document.getElementById('btnHdr').style.display = 'block';
  tab('tGen', document.querySelector('.tab'));
}

function volver() {
  show('sSearch');
  document.getElementById('btnHdr').style.display = 'none';
  document.getElementById('hSite').textContent = '‚Äî selecciona un sitio ‚Äî';
}

function llenarInm(fields) {
  F_INM.forEach(function(f) {
    var el = document.getElementById(f);
    if (!el) return;
    var val = fields[f];
    if (f === 'inicio_operaciones') {
      el.value = val ? val.substring(0, 10) : '';
      return;
    }
    if (val === null || val === undefined) { el.value = CERO.has(f) ? '0' : ''; return; }
    if (el.tagName === 'SELECT') { el.value = val; return; }
    el.value = val;
  });

}

function llenarPob(fields) {
  F_POB.forEach(function(f) {
    var el = document.getElementById(f);
    if (!el) return;
    var val = fields[f];
    el.value = (val !== null && val !== undefined) ? val : '';
  });
}

// Campos que se resetean a 0 (contadores), excepto PQS y CO2
const CERO = new Set([
  'accesos','salidas_emergencia','escaleras','escaleras_emergencia',
  'alarmas','detectores_humo','lamparas_emergencia','botiquin_emergencia',
  'ruta_evacuacion','salida_emergencia','punto_reunion','sismo_incendio',
  'se√±al_escaleras','zona_menor_riesgo','riesgo_electrico','area_restringida',
  'no_fumar','no_celular','no_gorra','no_lentes','no_estacionarse',
  'estacionamiento_discapacidad','rampa_discapacidad','velocidad_max',
  'edificios','niveles'
]);

function limpiar() {
  F_INM.concat(F_POB).forEach(function(f) {
    var el = document.getElementById(f);
    if (!el) return;
    if (el.tagName === 'SELECT') el.value = 'NO';
    else if (CERO.has(f)) el.value = '0';
    else el.value = '';
  });
  limpiarFotos();
}

function tab(id, btn) {
  document.querySelectorAll('.tc').forEach(function(t) { t.classList.remove('active'); });
  document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
  document.getElementById(id).classList.add('active');
  if (btn) btn.classList.add('active');
  if (id === 'tFirma') setTimeout(firmaInit, 50);
}

function cnt(fid, d) {
  var el = document.getElementById(fid);
  el.value = Math.max(0, (parseInt(el.value) || 0) + d);
}



function gps() {
  if (!navigator.geolocation) { toast('GPS no disponible', 'err'); return; }
  toast('Obteniendo ubicaci√≥n...', '');
  navigator.geolocation.getCurrentPosition(function(p) {
    document.getElementById('coordenadas').value = p.coords.latitude.toFixed(8) + ', ' + p.coords.longitude.toFixed(8);
    toast('‚úì Coordenadas capturadas', 'ok');
  }, function() { toast('No se pudo obtener GPS', 'err'); });
}

function fmtTel(input) {
  var d = input.value.replace(/\D/g, '').slice(0, 10);
  var o = '';
  if (d.length > 0) o = '(' + d.slice(0, 3);
  if (d.length >= 4) o += ') ' + d.slice(3, 6);
  if (d.length >= 7) o += '-' + d.slice(6, 10);
  input.value = o;
}

// ===== GUARDAR =====
function buildInm() {
  var fields = {};
  F_INM.forEach(function(f) {
    var el = document.getElementById(f);
    if (!el) return;
    if (f === 'inicio_operaciones') {
      var v = el.value.trim();
      if (v) fields[f] = v;
      return;
    }
    var val = el.tagName === 'SELECT' ? el.value : el.value.trim();
    if (val === '') return;
    if (NUM.has(f)) {
      var n = parseFloat(val);
      if (!isNaN(n)) fields[f] = n;
    } else {
      fields[f] = f === 'email' ? val : val.toUpperCase();
    }
  });
  return fields;
}

function buildPob() {
  var fields = {};
  F_POB.forEach(function(f) {
    var el = document.getElementById(f);
    if (!el) return;
    var val = el.value.trim();
    if (val === '') return;
    if (NUM.has(f)) {
      var n = parseFloat(val);
      if (!isNaN(n)) fields[f] = n;
    } else {
      fields[f] = val.toUpperCase();
    }
  });
  return fields;
}

// ===== OFFLINE QUEUE =====
var QUEUE_KEY = 'pipc_queue';

function queueGet() {
  try { return JSON.parse(localStorage.getItem(QUEUE_KEY) || '[]'); } catch(e) { return []; }
}
function queueSave(q) {
  localStorage.setItem(QUEUE_KEY, JSON.stringify(q));
}
function queueAdd(item) {
  var q = queueGet();
  item.qid = Date.now() + '_' + Math.random().toString(36).slice(2,7);
  item.savedAt = new Date().toLocaleString('es-MX');
  item.error = null;
  q.push(item);
  queueSave(q);
  actualizarBadge();
}
function queueRemove(qid) {
  var q = queueGet().filter(function(i) { return i.qid !== qid; });
  queueSave(q);
  actualizarBadge();
}

function actualizarBadge() {
  var q = queueGet();
  var badge = document.getElementById('pendBadge');
  var syncBar = document.getElementById('syncBar');
  var syncMsg = document.getElementById('syncMsg');
  if (q.length > 0) {
    badge.textContent = q.length + ' pendiente' + (q.length > 1 ? 's' : '');
    badge.style.display = 'inline-block';
    syncBar.classList.add('show');
    syncMsg.textContent = q.length + ' registro' + (q.length > 1 ? 's' : '') + ' sin sincronizar';
  } else {
    badge.style.display = 'none';
    syncBar.classList.remove('show');
  }
}

function hayInternet() {
  return navigator.onLine;
}

function actualizarOfflineBar() {
  var bar = document.getElementById('offlineBar');
  if (!hayInternet()) bar.classList.add('show');
  else bar.classList.remove('show');
}

window.addEventListener('online',  function() { actualizarOfflineBar(); actualizarBadge(); });
window.addEventListener('offline', function() { actualizarOfflineBar(); });

async function enviarAirtable(item) {
  var inmId;
  if (item.recId) {
    await PATCH(TBL_INM, item.recId, item.inm);
    inmId = item.recId;
  } else {
    var ri = await POST(TBL_INM, item.inm);
    inmId = ri.id;
  }

  var fPob = Object.assign({}, item.pob);
  fPob['Inmueble'] = [inmId];

  if (item.pobId) {
    await PATCH(TBL_POB, item.pobId, fPob);
  } else {
    var allPob2 = []; var off2 = null;
    do {
      var pg2 = await GET(TBL_POB, 'pageSize=100' + (off2 ? '&offset=' + off2 : ''));
      allPob2 = allPob2.concat(pg2.records || []);
      off2 = pg2.offset || null;
    } while (off2);
    var match2 = null;
    allPob2.forEach(function(r) {
      Object.keys(r.fields).forEach(function(k) {
        if (Array.isArray(r.fields[k]) && r.fields[k].indexOf(inmId) !== -1) match2 = r;
      });
    });
    if (match2) await PATCH(TBL_POB, match2.id, fPob);
    else await POST(TBL_POB, fPob);
  }
}

async function sincronizar() {
  var q = queueGet();
  if (q.length === 0) { toast('No hay registros pendientes', ''); return; }
  if (!hayInternet()) { toast('Sin conexi√≥n a internet', 'err'); return; }

  var btn = document.querySelector('.btn-sync');
  btn.disabled = true; btn.textContent = 'Sincronizando...';

  var ok = 0; var fail = 0;
  for (var i = 0; i < q.length; i++) {
    try {
      await enviarAirtable(q[i]);
      queueRemove(q[i].qid);
      ok++;
    } catch(e) {
      q[i].error = e.message;
      fail++;
    }
  }
  if (fail > 0) queueSave(queueGet()); // guardar errores actualizados

  btn.disabled = false; btn.textContent = '‚Üë SINCRONIZAR';
  actualizarBadge();

  if (fail === 0) toast('‚úì ' + ok + ' registro' + (ok>1?'s':'') + ' sincronizado' + (ok>1?'s':''), 'ok');
  else toast(ok + ' OK, ' + fail + ' con error', 'err');
}

// ===== GUARDAR (con soporte offline) =====
async function guardar() {
  var bs = document.getElementById('btnSave');
  var bh = document.getElementById('btnHdr');
  bs.disabled = true; bs.textContent = 'Guardando...';
  bh.disabled = true;

  var fInm = buildInm();
  var fPob = buildPob();

  if (!hayInternet()) {
    // Guardar en cola local
    queueAdd({ recId: recId, pobId: pobId, inm: fInm, pob: fPob,
               nombre: fInm.nombre_comercial || 'Sin nombre' });
    toast('üì• Guardado sin conexi√≥n ‚Äî pendiente de sync', '');
    bs.disabled = false; bs.textContent = 'üíæ GUARDAR EN AIRTABLE';
    bh.disabled = false;
    return;
  }

  try {
    await enviarAirtable({ recId: recId, pobId: pobId, inm: fInm, pob: fPob });
    toast('‚úì Guardado correctamente', 'ok');
  } catch(e) {
    // Si falla por red, guardar en cola
    if (!hayInternet() || e.message.includes('fetch') || e.message.includes('network') || e.message.includes('Failed')) {
      queueAdd({ recId: recId, pobId: pobId, inm: fInm, pob: fPob,
                 nombre: fInm.nombre_comercial || 'Sin nombre' });
      toast('üì• Sin conexi√≥n ‚Äî guardado localmente', '');
    } else {
      toast('Error: ' + e.message, 'err');
    }
  } finally {
    bs.disabled = false; bs.textContent = 'üíæ GUARDAR EN AIRTABLE';
    bh.disabled = false;
  }
}

// ===== UI =====
function stMsg(msg, type) {
  var el = document.getElementById('statusMsg');
  el.textContent = msg; el.className = 'status ' + type;
}
function clrMsg() { document.getElementById('statusMsg').className = 'status'; }

var toastTmr;
function toast(msg, type) {
  var t = document.getElementById('toast');
  t.textContent = msg; t.className = 'toast show ' + (type || '');
  clearTimeout(toastTmr);
  toastTmr = setTimeout(function() { t.classList.remove('show'); }, 3500);
}

// ===== FOTOS =====
// Almac√©n en memoria: { filename ‚Üí File }
var fotosEnMemoria = {};

// Estado temporal del slot que se est√° editando
var _slotActivo = null;
var _fileActivo = null;

function selectFoto(slotId, filename) {
  _slotActivo = { slotId: slotId, filename: filename };
  document.getElementById('fotoMenuLabel').textContent = filename;
  document.getElementById('fotoMenuOverlay').classList.add('show');
}

function cerrarMenuFoto(e) {
  if (e && e.target !== document.getElementById('fotoMenuOverlay')) return;
  document.getElementById('fotoMenuOverlay').classList.remove('show');
}

function usarCamara() {
  document.getElementById('fotoMenuOverlay').classList.remove('show');
  _abrirInput(true);
}

function usarGaleria() {
  document.getElementById('fotoMenuOverlay').classList.remove('show');
  _abrirInput(false);
}

function _abrirInput(camara) {
  if (!_slotActivo) return;
  var input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  if (camara) input.setAttribute('capture', 'environment');
  input.onchange = function() {
    if (!input.files[0]) return;
    var file = input.files[0];
    var s = _slotActivo;
    fotosEnMemoria[s.filename] = file;
    var slot  = document.getElementById('slot_'  + s.slotId);
    var thumb = document.getElementById('thumb_' + s.slotId);
    thumb.src = URL.createObjectURL(file);
    slot.classList.add('done');
    actualizarContadorFotos();
    _slotActivo = null;
  };
  input.click();
}

function selectBulkSufijo(bid, base, maxFiles) {
  // Genera: base.jpg, base1.jpg, base2.jpg ...
  var input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  input.multiple = true;
  input.onchange = function() {
    var files = Array.from(input.files);
    if (!files.length) return;
    var container = document.getElementById('thumbs_' + bid);
    var counter   = document.getElementById('cnt_' + bid);
    container.innerHTML = '';
    // Limpiar entradas anteriores de este lote
    Object.keys(fotosEnMemoria).forEach(function(k) {
      if (k === base + '.jpg' || k.startsWith(base + '0') || k.match(new RegExp('^' + base + '\\d+\\.jpg$'))) {
        delete fotosEnMemoria[k];
      }
    });
    files.forEach(function(file, i) {
      var fname = i === 0 ? base + '.jpg' : base + i + '.jpg';
      fotosEnMemoria[fname] = file;
      var img = document.createElement('img');
      img.className = 'bulk-thumb';
      img.title = fname;
      img.src = URL.createObjectURL(file);
      container.appendChild(img);
    });
    counter.textContent = files.length + ' sel.';
    actualizarContadorFotos();
  };
  input.click();
}

function selectBulk(bid, base, maxn) {
  var input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  input.multiple = true;
  input.onchange = function() {
    var files = Array.from(input.files);
    if (!files.length) return;
    var container = document.getElementById('thumbs_' + bid);
    var counter   = document.getElementById('cnt_' + bid);
    container.innerHTML = '';
    // Limpiar entradas anteriores de este lote
    Object.keys(fotosEnMemoria).forEach(function(k) {
      if (k.startsWith(base + ' (') || k.startsWith(base + '(')) delete fotosEnMemoria[k];
    });
    files.forEach(function(file, i) {
      var fname = base + ' (' + (i + 1) + ').jpg';
      fotosEnMemoria[fname] = file;
      var img = document.createElement('img');
      img.className = 'bulk-thumb';
      img.title = fname;
      img.src = URL.createObjectURL(file);
      container.appendChild(img);
    });
    counter.textContent = files.length + ' seleccionada' + (files.length > 1 ? 's' : '');
    actualizarContadorFotos();
  };
  input.click();
}

function actualizarContadorFotos() {
  var n = Object.keys(fotosEnMemoria).length;
  var btn = document.getElementById('btnDescargaZip');
  var lbl = document.getElementById('lblFotosZip');
  if (!btn) return;
  if (n === 0) {
    btn.disabled = true;
    lbl.textContent = 'Selecciona fotos para generar el ZIP';
  } else {
    btn.disabled = false;
    lbl.textContent = n + ' foto' + (n > 1 ? 's' : '') + ' lista' + (n > 1 ? 's' : '') + ' para descargar';
  }
}

function _descargarDirecto(blob, nombre) {
  var url = URL.createObjectURL(blob);
  var a   = document.createElement('a');
  a.href = url;
  a.download = nombre + '.zip';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(function() { URL.revokeObjectURL(url); }, 2000);
}

async function descargarZip() {
  var nombre = document.getElementById('nombre_comercial').value.trim() || 'SITIO';
  var n = Object.keys(fotosEnMemoria).length;
  if (n === 0) { toast('No hay fotos seleccionadas', 'err'); return; }

  var btn = document.getElementById('btnDescargaZip');
  btn.disabled = true;
  btn.textContent = '‚è≥ Generando ZIP...';

  try {
    var zip = new JSZip();
    var carpeta = zip.folder(nombre);
    // Leer cada archivo y agregarlo al ZIP
    var promesas = Object.keys(fotosEnMemoria).map(function(fname) {
      return new Promise(function(resolve) {
        var reader = new FileReader();
        reader.onload = function(e) {
          carpeta.file(fname, e.target.result.split(',')[1], {base64: true});
          resolve();
        };
        reader.readAsDataURL(fotosEnMemoria[fname]);
      });
    });
    await Promise.all(promesas);

    var blob = await zip.generateAsync({type: 'blob', compression: 'DEFLATE', compressionOptions: {level: 3}});
    var zipFile = new File([blob], nombre + '.zip', {type: 'application/zip'});

    // Web Share API: muestra menu nativo con OneDrive, Drive, etc.
    if (navigator.canShare && navigator.canShare({files: [zipFile]})) {
      try {
        await navigator.share({ files: [zipFile], title: nombre + '.zip' });
        toast('‚úì ZIP compartido: ' + nombre + '.zip', 'ok');
      } catch(shareErr) {
        // Usuario cancelo el menu: no es error
        if (shareErr.name !== 'AbortError') {
          _descargarDirecto(blob, nombre);
          toast('‚úì ZIP descargado: ' + nombre + '.zip', 'ok');
        }
      }
    } else {
      // Fallback: descarga directa (escritorio o navegador sin soporte)
      _descargarDirecto(blob, nombre);
      toast('‚úì ZIP descargado: ' + nombre + '.zip', 'ok');
    }
  } catch(e) {
    toast('Error al generar ZIP: ' + e.message, 'err');
  } finally {
    btn.disabled = false;
    btn.textContent = 'üì¶ DESCARGAR ZIP';
  }
}

// Limpiar fotos al crear nuevo registro o abrir uno existente
function limpiarFotos() {
  fotosEnMemoria = {};
  document.querySelectorAll('.foto-slot').forEach(function(s) {
    s.classList.remove('done');
  });
  document.querySelectorAll('.foto-thumb').forEach(function(i) { i.src = ''; });
  document.querySelectorAll('.bulk-thumbs').forEach(function(c) { c.innerHTML = ''; });
  document.querySelectorAll('[id^="cnt_"]').forEach(function(el) { el.textContent = '0 seleccionadas'; });
  actualizarContadorFotos();
}

// ===== FIRMA =====
var firmaCtx, firmaDrawing = false, firmaVacia = true;

function firmaInit() {
  var canvas = document.getElementById('firmaCanvas');
  var wrap   = document.getElementById('firmaWrap');
  // Ajustar resoluci√≥n al tama√±o real
  canvas.width  = canvas.offsetWidth  * window.devicePixelRatio;
  canvas.height = canvas.offsetHeight * window.devicePixelRatio;
  firmaCtx = canvas.getContext('2d');
  firmaCtx.scale(window.devicePixelRatio, window.devicePixelRatio);
  firmaCtx.strokeStyle = '#1a3db5';
  firmaCtx.lineWidth   = 3.5;
  firmaCtx.lineCap     = 'round';
  firmaCtx.lineJoin    = 'round';
  firmaCtx.clearRect(0, 0, canvas.offsetWidth, canvas.offsetHeight);

  function pos(e) {
    var r = canvas.getBoundingClientRect();
    var src = e.touches ? e.touches[0] : e;
    return { x: src.clientX - r.left, y: src.clientY - r.top };
  }
  function start(e) {
    e.preventDefault();
    firmaDrawing = true; firmaVacia = false;
    wrap.classList.add('activo');
    var p = pos(e);
    firmaCtx.beginPath();
    firmaCtx.moveTo(p.x, p.y);
  }
  function move(e) {
    e.preventDefault();
    if (!firmaDrawing) return;
    var p = pos(e);
    firmaCtx.lineTo(p.x, p.y);
    firmaCtx.stroke();
  }
  function end(e) { e.preventDefault(); firmaDrawing = false; }

  canvas.addEventListener('mousedown',  start, {passive:false});
  canvas.addEventListener('mousemove',  move,  {passive:false});
  canvas.addEventListener('mouseup',    end,   {passive:false});
  canvas.addEventListener('touchstart', start, {passive:false});
  canvas.addEventListener('touchmove',  move,  {passive:false});
  canvas.addEventListener('touchend',   end,   {passive:false});
}

function firmaClear() {
  var canvas = document.getElementById('firmaCanvas');
  firmaCtx.clearRect(0, 0, canvas.offsetWidth, canvas.offsetHeight);
  firmaVacia = true;
  document.getElementById('firmaWrap').classList.remove('activo');
  document.getElementById('firmaPreview').style.display = 'none';
  // Quitar del ZIP
  delete fotosEnMemoria['firma.png'];
  actualizarContadorFotos();
}

function firmaGuardar() {
  if (firmaVacia) { toast('Primero firma en el recuadro', 'err'); return; }
  var canvas = document.getElementById('firmaCanvas');
  var ctx    = firmaCtx;
  var w = canvas.width, h = canvas.height;
  var data   = ctx.getImageData(0, 0, w, h).data;

  // Encontrar bounding box de los p√≠xeles con alpha > 0
  var minX = w, minY = h, maxX = 0, maxY = 0;
  for (var y = 0; y < h; y++) {
    for (var x = 0; x < w; x++) {
      var a = data[(y * w + x) * 4 + 3];
      if (a > 0) {
        if (x < minX) minX = x;
        if (x > maxX) maxX = x;
        if (y < minY) minY = y;
        if (y > maxY) maxY = y;
      }
    }
  }
  // Margen de 10px alrededor de la firma
  var pad = 10;
  minX = Math.max(0, minX - pad);
  minY = Math.max(0, minY - pad);
  maxX = Math.min(w, maxX + pad);
  maxY = Math.min(h, maxY + pad);
  var fw = maxX - minX, fh = maxY - minY;

  // Copiar solo esa regi√≥n a un canvas temporal
  var tmp = document.createElement('canvas');
  tmp.width  = fw;
  tmp.height = fh;
  var tctx = tmp.getContext('2d');
  tctx.drawImage(canvas, minX, minY, fw, fh, 0, 0, fw, fh);

  tmp.toBlob(function(blob) {
    fotosEnMemoria['firma.png'] = new File([blob], 'firma.png', {type:'image/png'});
    actualizarContadorFotos();
    var url = URL.createObjectURL(blob);
    document.getElementById('firmaPreviewImg').src = url;
    document.getElementById('firmaPreview').style.display = 'block';
    toast('‚úì firma.png agregada al ZIP', 'ok');
  }, 'image/png');
}



// ===== INIT =====
checkKey();
actualizarOfflineBar();
actualizarBadge();
</script>
<!-- Men√∫ foto individual -->
<div class="foto-menu-overlay" id="fotoMenuOverlay" onclick="cerrarMenuFoto(event)">
  <div class="foto-menu">
    <div class="foto-menu-title" id="fotoMenuLabel">SELECCIONAR FOTO</div>
    <button class="foto-menu-btn" onclick="usarCamara()">
      <span style="font-size:22px">üì∑</span>
      <span>Tomar foto</span>
    </button>
    <button class="foto-menu-btn" onclick="usarGaleria()">
      <span style="font-size:22px">üñºÔ∏è</span>
      <span>Elegir de galer√≠a</span>
    </button>
    <button class="foto-menu-cancel" onclick="cerrarMenuFoto()">Cancelar</button>
  </div>
</div>
</body>
</html>
